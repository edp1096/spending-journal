<html x-data="allData" x-init="$watch('lightmode', value => localStorage.setItem('lightmode', value))" :data-theme="lightmode ? 'light' : 'dark'">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>지출기입장</title>

    <link rel="stylesheet" href="assets/css/pico.min.css">
    <link rel="stylesheet" href="assets/css/pico.colors.min.css">
    <script src="assets/js/alpine.min.js" defer></script>

    <link rel="stylesheet" href="assets/icons/material.css">
    <link rel="stylesheet" href="assets/css/styles.css">
    <script src="assets/js/scripts.js"></script>
</head>

<!-- data-theme="light" -->

<body>
    <div class="main-container">

        <!-- Main menu -->
        <div class="main-header-container">
            <h2>지출기입장</h2>

            <div class="header-button-container">
                <button @click="showHome" class="outline secondary icon-button icon-align">
                    <span class="icon">home</span> 홈
                </button>

                <button @click="showAccounts" class="outline secondary icon-button icon-align">
                    <span class="icon">book_5</span> 계정
                </button>
                <button @click="showRecords" class="outline secondary icon-button icon-align ">
                    <span class="icon">edit_note</span> 지출입
                </button>
                <button @click="openPreference" class="outline secondary icon-button icon-align">
                    <span class="icon">settings</span> 설정
                </button>
            </div>
        </div>

        <!-- Blank screen -->
        <template x-if="!showAccountList && !showRecordList">
            <div class="table-container"></div>
        </template>

        <!-- Payment accounts -->
        <template x-if="showAccountList">
            <div class="table-container">
                <button @click="openInputAccount" class="full-size bg-jade icon-align">
                    계정 추가 <span class="icon">add</span>
                </button>

                <table>
                    <thead>
                        <template x-if="accounts.length > 0">
                            <tr>
                                <th>계정 이름</th>
                                <th>계정 유형</th>
                                <th>결제일</th>
                                <th>삭제</th>
                            </tr>
                        </template>
                    </thead>
                    <tbody>
                        <template x-for="(m, index) in accounts" :key="index">
                            <tr @click="openInputAccount(index)">
                                <td x-text="m['account-name']"></td>
                                <td x-text="`${payType[m['pay-type']]}`"></td>
                                <td x-text="m['repay-day']"></td>
                                <td class="one td-center">
                                    <button @click.stop="deleteAccount(index)" type="button" class="bg-orange">X</button>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
        </template>

        <!-- Payment records -->
        <template x-if="showRecordList">
            <div class="table-container">
                <button @click="openInputRecord" class="full-size bg-jade icon-align">
                    기록 추가 <span class="icon">add</span>
                </button>

                <table>
                    <thead>
                        <template x-if="recordsResponse.records && recordsResponse.records.length > 0">
                            <tr>
                                <th class="th-center">일시</th>
                                <th class="th-center">분류</th>
                                <th class="th-center">지불</th>
                                <th class="th-center">금액</th>
                                <th class="th-center">삭제</th>
                            </tr>
                        </template>
                    </thead>
                    <tbody>
                        <template x-for="(r, index) in recordsResponse.records" :key="index">
                            <tr @click="openInputRecord(index)">
                                <td x-text="`${r.date} ${r.time}`"></td>
                                <td x-text="r.category"></td>
                                <td x-text="`${payType[r['pay-type']]}`"></td>
                                <td x-text="`${currencyCode[r.currency]} ${r.amount}`"></td>
                                <td class="one td-center">
                                    <button @click.stop="deleteRecord(index)" type="button" class="bg-orange">X</button>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
        </template>

        <hr>

        <div class="summary-container">
            <div class="full-size hgt2-1 flex-row right">
                <label>기간:</label>
                <input x-model="summaryDateFrom" :change="getRecords" class="date-mini wdt-38" type="date">
                <span class="divider-v">~</span>
                <input x-model="summaryDateTo" :change="getRecords" class="date-mini wdt-38" type="date">
            </div>

            <div>
                <span x-text="`수입: ${(recordsResponse['sum-income'] ?? 0)}`"></span>
                <span x-text="`지출: ${(recordsResponse['sum-pay'] ?? 0)}`"></span>
                <span x-text="`신용: ${(recordsResponse['sum-scheduled-pay'] ?? 0)}`"></span>
            </div>
        </div>
    </div>

    <!-- Entering password input -->
    <div x-data="{ open: true }" x-init="$refs.passwordInput.focus()" id="password-gate-container">
        <div id="password-gate" x-show="open" x-transition class="dialog-fullsize dialog-enter-password">
            <h3 class="icon-align">
                비밀번호를 입력해주세요 <span class="icon md-36">lock</span>
            </h3>

            <form x-ref="passwordForm">
                <input x-ref="passwordInput" type="password" id="password" placeholder="비밀번호 입력" required>
                <button @click="enterPassword($event)">확인</button>
            </form>
        </div>
    </div>

    <!-- Add/Edit pay account -->
    <div x-data="accountData" @keyup.escape.window="open = false">
        <form x-ref="accountForm" class="dialog-fullsize dialog-add-edit" x-show="open" x-transition>
            <h2>계정 정보 입력/수정</h2>

            <input x-model="account['account-name']" :change="checkAccountNameDuplicate()" placeholder="계정 이름(카드/통장/지갑 등)" required>
            <select x-model="account['pay-type']">
                <option value="direct">직불/현금</option>
                <option value="credit">신용/외상</option>
                <option value="hybrid">복합(체크+신용)</option>
            </select>

            <select x-model="account['repay-day']">
                <option value="">월 결제일</option>
                <template x-for="day in 31" :key="day">
                    <option :value="day" x-text="day"></option>
                </template>
            </select>

            <select x-model="account['use-day-from']">
                <option value="">카드 이용 시작일(전전월 또는 전월)</option>
                <template x-for="day in 31" :key="day">
                    <option :value="day" x-text="day"></option>
                </template>
            </select>

            <select x-model="account['use-day-to']">
                <option value="">카드 이용 종료일(전월 또는 당월)</option>
                <template x-for="day in 31" :key="day">
                    <option :value="day" x-text="day"></option>
                </template>
            </select>

            <textarea x-model="account.description" placeholder="메모"></textarea>

            <div class="dialog-button-container">
                <button @click.stop="open = !open" type="button" class="bg-red">취소</button>
                <button @click.stop="setAccount($event)" type="button">확인</button>
            </div>
        </form>
    </div>

    <!-- Add/Edit record -->
    <div x-data="recordData" @keyup.escape.window="open = false">
        <form x-ref="recordForm" class="dialog-fullsize dialog-add-edit" x-show="open" x-transition>
            <h2>거래 입력/수정</h2>

            <select x-model="record['transaction-type']">
                <option value="record_type_pay">지출</option>
                <option value="record_type_income">수입</option>
            </select>

            <select x-model="record['pay-type']">
                <option value="direct">직불/현금</option>
                <option value="credit">신용/외상</option>
            </select>

            <div class="datalist-input-container">
                <input x-model="accountName" :change="setRecordPayType" x-ref="payAccount" list="account-list" placeholder="계정 (현금/통장/카드 등)" required>
                <datalist id="account-list">
                    <template x-for="(a, index) in accounts" :key="index">
                        <option :value="a['account-name']"></option>
                    </template>
                </datalist>
                <button @click="accountName=''; $refs.payAccount.focus()" class="clear bg-orange" type="button">X</button>
            </div>

            <div class="datalist-input-container">
                <input x-model="record.category" x-ref="payCategory" list="category-list" placeholder="분류" required>
                <datalist id="category-list">
                    <option value="식비">
                    <option value="간식">
                    <option value="교통">
                    <option value="담배">
                </datalist>
                <button @click="record.category=''; $refs.payCategory.focus()" class="clear bg-orange" type="button">X</button>
            </div>

            <select x-model="record.currency" class="third">
                <option value="KRW">원</option>
                <option value="USD">달러</option>
            </select>
            <input x-model="record.amount" type="number" :step="step[record.currency]" class="seventh" placeholder="금액" required>

            <input x-model="record.date" class="half-size" type="date" placeholder="거래일">
            <input x-model="record.time" class="half-size" type="time" placeholder="거래시간">
            <textarea x-model="record.description" placeholder="메모"></textarea>

            <div class="dialog-button-container">
                <button @click="open = !open" type="button" class="bg-red">취소</button>
                <button @click="setRecord($event)" type="button">확인</button>
            </div>
        </form>
    </div>

    <!-- Preference -->
    <div x-data="preferenceData" @keyup.escape.window="open = false">
        <form x-ref="preferenceForm" class="dialog-fullsize dialog-add-edit" x-show="open" x-transition>
            <h2>설정</h2>

            <h3>비밀번호</h3>
            <input x-model="preferences['old-password']" type="password" placeholder="기존 비밀번호" required>
            <input x-model="preferences['new-password']" type="password" placeholder="신규 비밀번호" required>

            <div class="dialog-section-button-container">
                <button @click="changePassword($event)" type="button">비밀번호 변경</button>
            </div>

            <div class="dialog-section-button-container switch-padding">
                <label class="full-size">
                    <input x-model="lightmode" type="checkbox" role="switch" checked />
                    밝게 보기
                </label>
            </div>

            <div class="dialog-button-container">
                <button @click="open = !open" type="button" class="bg-red">닫기</button>
            </div>
        </form>
    </div>

</body>

</html>